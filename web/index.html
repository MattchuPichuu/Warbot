<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>War Timer Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        input, select, button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        input[type="text"] {
            flex: 1;
            min-width: 150px;
        }

        select {
            min-width: 150px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
        }

        button:hover {
            background: #5568d3;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        .timer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .timer-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .timer-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timer-item {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .timer-item strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .timer-info {
            font-size: 0.9em;
            color: #666;
            margin: 3px 0;
        }

        .pro-drop {
            background: #e8f5e9;
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 5px;
            font-weight: bold;
            color: #2e7d32;
        }

        .status-bar {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-bar .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            color: #999;
            margin-bottom: 10px;
        }

        .icon {
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öîÔ∏è War Timer Dashboard</h1>
            <p class="subtitle">Real-time War Timer Tracking System</p>
        </header>

        <div id="error" class="error-message"></div>

        <div class="controls">
            <div class="form-group">
                <input type="text" id="userName" placeholder="Your Name" />
                <input type="text" id="timeShot" placeholder="Time (HH:MM:SS)" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" />
                <select id="timerType">
                    <option value="friendly_hit">üõ°Ô∏è Friendly Hit</option>
                    <option value="pro_whack">üíÄ Pro Whack</option>
                    <option value="enemy_hit">‚öîÔ∏è Enemy Hit</option>
                </select>
                <button onclick="addTimer()">Add Timer</button>
                <button onclick="refreshTimers()">üîÑ Refresh</button>
                <button onclick="clearAllTimers()" class="danger">Clear All</button>
            </div>
        </div>

        <div class="timer-grid" id="timerGrid">
            <!-- Timers will be loaded here -->
        </div>

        <div class="status-bar">
            <div class="status">
                <div class="status-dot"></div>
                <span>Auto-refresh: <span id="countdown">5</span>s</span>
            </div>
            <span>Last updated: <span id="lastUpdate">Never</span></span>
        </div>
    </div>

    <script>
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://127.0.0.1:8000'
            : `http://${window.location.hostname}:8000`;
        const API_KEY = 'your_api_key_here'; // Replace with your actual API key
        let refreshInterval;
        let countdownInterval;
        let countdown = 5;

        // Format time from ISO string to HH:MM:SS
        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour12: false });
        }

        // Format datetime from ISO string
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Fetch and display timers
        async function refreshTimers() {
            try {
                const response = await fetch(`${API_URL}/timers/?limit=500`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const timers = await response.json();
                displayTimers(timers);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error fetching timers:', error);
                showError(`Failed to fetch timers: ${error.message}`);
            }
        }

        // Display timers in cards
        function displayTimers(timers) {
            const grid = document.getElementById('timerGrid');

            if (timers.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>No Active Timers</h3>
                        <p>Add a timer using the form above</p>
                    </div>
                `;
                return;
            }

            // Group timers by type
            const friendlyHits = timers.filter(t => t.timer_type === 'friendly_hit');
            const proWhacks = timers.filter(t => t.timer_type === 'pro_whack');
            const enemyHits = timers.filter(t => t.timer_type === 'enemy_hit');

            let html = '';

            // Friendly Hits Card
            if (friendlyHits.length > 0) {
                html += `
                    <div class="timer-card">
                        <h3><span class="icon">üõ°Ô∏è</span> Friendly Hits (${friendlyHits.length})</h3>
                        ${friendlyHits.map(timer => `
                            <div class="timer-item">
                                <strong>${timer.user_name}</strong>
                                <div class="timer-info">Hit Time: ${formatTime(timer.time_shot)}</div>
                                ${timer.pro_drop_start ? `
                                    <div class="pro-drop">
                                        Pro Drop: ${formatTime(timer.pro_drop_start)} - ${formatTime(timer.pro_drop_end)}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Pro Whacks Card
            if (proWhacks.length > 0) {
                html += `
                    <div class="timer-card">
                        <h3><span class="icon">üíÄ</span> Pro Whacks (${proWhacks.length})</h3>
                        ${proWhacks.map(timer => `
                            <div class="timer-item">
                                <strong>${timer.user_name}</strong>
                                <div class="timer-info">Whack Time: ${formatTime(timer.time_shot)}</div>
                                ${timer.pro_drop_start ? `
                                    <div class="pro-drop">
                                        Pro Drop: ${formatTime(timer.pro_drop_start)}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Enemy Hits Card
            if (enemyHits.length > 0) {
                html += `
                    <div class="timer-card">
                        <h3><span class="icon">‚öîÔ∏è</span> Enemy Hits (${enemyHits.length})</h3>
                        ${enemyHits.map(timer => `
                            <div class="timer-item">
                                <strong>${timer.user_name}</strong>
                                <div class="timer-info">Hit Time: ${formatTime(timer.time_shot)}</div>
                                ${timer.pro_drop_start ? `
                                    <div class="pro-drop">
                                        Pro Drop Start: ${formatTime(timer.pro_drop_start)}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            grid.innerHTML = html;
        }

        // Add a new timer
        async function addTimer() {
            const userName = document.getElementById('userName').value.trim();
            const timeShot = document.getElementById('timeShot').value.trim();
            const timerType = document.getElementById('timerType').value;

            if (!userName || !timeShot) {
                showError('Please enter both name and time');
                return;
            }

            // Validate time format
            if (!/^\d{2}:\d{2}:\d{2}$/.test(timeShot)) {
                showError('Invalid time format. Use HH:MM:SS (e.g., 14:30:25)');
                return;
            }

            try {
                // Create ISO datetime from time string
                const now = new Date();
                const [hours, minutes, seconds] = timeShot.split(':').map(Number);
                const shotTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, seconds);

                // If time is in the future, assume it was yesterday
                if (shotTime > now) {
                    shotTime.setDate(shotTime.getDate() - 1);
                }

                const response = await fetch(`${API_URL}/timers/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        user_name: userName,
                        timer_type: timerType,
                        time_shot: shotTime.toISOString()
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `API error: ${response.status}`);
                }

                // Clear form
                document.getElementById('userName').value = '';
                document.getElementById('timeShot').value = '';

                // Refresh timers
                await refreshTimers();
            } catch (error) {
                console.error('Error adding timer:', error);
                showError(`Failed to add timer: ${error.message}`);
            }
        }

        // Clear all timers
        async function clearAllTimers() {
            if (!confirm('Are you sure you want to clear all timers?')) {
                return;
            }

            try {
                // Fetch all timers
                const response = await fetch(`${API_URL}/timers/?limit=500`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const timers = await response.json();

                // Delete each timer
                for (const timer of timers) {
                    await fetch(`${API_URL}/timers/${timer.id}`, {
                        method: 'DELETE',
                        headers: {
                            'X-API-Key': API_KEY
                        }
                    });
                }

                await refreshTimers();
            } catch (error) {
                console.error('Error clearing timers:', error);
                showError(`Failed to clear timers: ${error.message}`);
            }
        }

        // Update countdown
        function updateCountdown() {
            countdown--;
            document.getElementById('countdown').textContent = countdown;

            if (countdown <= 0) {
                countdown = 5;
                refreshTimers();
            }
        }

        // Initialize
        function init() {
            // Load timers immediately
            refreshTimers();

            // Set up auto-refresh
            countdownInterval = setInterval(updateCountdown, 1000);

            // Allow Enter key to add timer
            document.getElementById('timeShot').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTimer();
                }
            });
        }

        // Start when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
